---
title: "Synergistic effects between global warming and water quality change on modelled macrophyte species richness"
author: "Anne Lewerentz, et al"
date: "`r Sys.Date()`"
output:
  html_document:
    code_folding: hide
    number_sections: true
    toc: true
    toc_float: true
    theme: united
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message=FALSE, out.width = "80%")
```


# Methods and Setup 
## Load Packages 
```{r load packages, results='hide', message=FALSE}
library(LewerentzEtAl2022)
library(data.table)
library(here)
library(tidyverse)
library(styler)
library(corrplot)
library(RColorBrewer)
library(ggrepel)
library(ggpmisc)
library(ggpubr)
library(kableExtra)
library(knitr)
library(BBmisc) #normalize function
library(factoextra) #PCA
library(magrittr)

# GLM outputs
library(sjPlot)
library(sjmisc)
library(sjlabelled)
library(jtools)
library(patchwork) # combine figures
library(colorBlindness) # check colors
library(rcartocolor)

```



## Set theme & colors
```{r create ggplot theme, fig.height=2.5}

theme_analysis <- function(base_size = 14) {
  theme_minimal(base_size = base_size) %+replace%
    theme(
      # changed theme options
    )
}
# Changing the default theme
theme_set(theme_analysis())

# See options within package
#depthPalette <- carto_pal(5, "Teal")[2:5]
#TempPalette<- carto_pal(3, "Peach")
#TurbNutrPalette<- carto_pal(7, "Earth")[c(1:4)]
WinnerLoserPalette<- c(carto_pal(2,"PinkYl")[c(2)],carto_pal(2,"TealGrn")[c(1)])
TrophiePalette <- c("cornflowerblue","aquamarine4","coral4")
displayAllColors(TrophiePalette)


```




# Results
## Overview lake grouping
Mean geographic variables per lake group:
```{r}
data_lakes_env_class %>% 
  left_join(Morphology, by=c("LakeName"="Name_Makro_short") ) %>% 
  group_by(class) %>% 
  summarise(Area_mean_ha=mean(Area_ha), 
            maxDepth_mean_m=mean(maxDepth_m),
            Altitude_mean_masl=mean(Altitude_masl),
            CatchArea_mean_km2=mean(CatchmentArea_km2))%>% 
  kable() %>% kable_styling()

```



Number of Lakes per Lake group:

```{r}
data_lakes_env_class %>% count(class) %>% kable() %>% kable_styling()
```









## Q1 - Base scenario


### Bavaria: N of species 
```{r, results='hide', message=FALSE}
surv_spec <- data %>%
  filter(Biomass_cat != 0) %>%
  distinct(Species)

NSPECtotal <- data %>% select(specNr) %>% unique() %>% count()
NLAKEStotal <- data %>% select(lakeNr) %>% unique() %>% count()

NSPECbase <- dim(surv_spec)[[1]]


```
In total, `r NSPECbase` species out of `r NSPECtotal` can grow in `r NLAKEStotal` real lakes. 
These `r NSPECbase` will be called as 100%. 




```{r message=FALSE, warning=FALSE}
Tv1<-data %>%
  #filter(Biomass_cat != 0) %>% 
  group_by(Group) %>%
  distinct(Species) %>% count(Group)

Tv2<-data %>%
  #filter(Biomass_cat != 0) %>% 
  group_by(Biomass_cat,Group) %>%
  distinct(Species) %>% count(Group) %>%
  spread("Biomass_cat","n") %>%
  rename("growing"="1")

d1nsp<-data %>%
  filter(depth_1 != 0) %>%
  group_by(Group) %>%
  distinct(Species) %>%
  count(Group) %>%
  rename("depth_1"="n")
  
d2nsp<-data %>%
  filter(depth_2 != 0) %>%
  group_by(Group) %>%
  distinct(Species) %>%
  count(Group) %>%
  rename("depth_2"="n")
d3nsp<-data %>%
  filter(depth_3 != 0) %>%
  group_by(Group) %>%
  distinct(Species) %>%
  count(Group) %>%
  rename("depth_3"="n")
d4nsp<-data %>%
  filter(depth_4 != 0) %>%
  group_by(Group) %>%
  distinct(Species) %>%
  count(Group) %>%
  rename("depth_4"="n")

NSpGroups<-left_join(Tv1, Tv2, by="Group") %>% 
  rename("space"="n") %>% select(-`0`) %>%
  left_join(d1nsp,by="Group") %>% left_join(d2nsp,by="Group") %>%
  left_join(d3nsp,by="Group")%>% left_join(d4nsp,by="Group") %>%
  mutate(growing_P=(growing/NSPECbase)*100)%>%
  mutate(depth_1_P=(depth_1/NSPECbase)*100)%>%
  mutate(depth_2_P=(depth_2/NSPECbase)*100)%>%
  mutate(depth_3_P=(depth_3/NSPECbase)*100)%>%
  mutate(depth_4_P=(depth_4/NSPECbase)*100)%>%
  select(-depth_1,-depth_2,-depth_3,-depth_4)

knitr::kable(NSpGroups, digits = 1) %>% kable_styling()
```

Summarized for the whole dataset: 

Thus, it's a hump-shaped pattern of possible species richness of submerged macrophytes. 


How does that look like for real species 

```{r}

knitr::kable(MAK_grouped_depthindep_alllakes, digits = 1) %>% kable_styling()
```







Complete number of species within the mapped datasets, just indicator species  `r MAK_MAPPED_NSPEC_indicationspec`




<br/><br/>

### Number of species per lake

```{r, results='hide', message=FALSE}
richLake<-data %>%
  group_by(Lake) %>%
  summarise_at(vars(Biomass_cat), ~ sum(. != 0)) %>%
  arrange(Biomass_cat) %>% # depth_1,depth_2,depth_3,depth_4,
  rename("Nspecies" = Biomass_cat) %>%
  filter(Nspecies==max(Nspecies))

richLakeName <- MAK_MAPPED %>% filter(LakeID==richLake$Lake) %>% select(Lake) %>% unique()

poorLake<-data %>%
  group_by(Lake) %>%
  summarise_at(vars(Biomass_cat), ~ sum(. != 0)) %>%
  arrange(Biomass_cat) %>% # depth_1,depth_2,depth_3,depth_4,
  rename("Nspecies" = Biomass_cat) %>%
  filter(Nspecies==min(Nspecies))

poorLakeName <- MAK_MAPPED %>% filter(LakeID==poorLake$Lake) %>% select(Lake) %>% unique()
```

Per lake between `r poorLake[1,2]` (`r poorLake[1,1]` in `r poorLakeName[1,1]`,  - `r round(poorLake[1,2]/NSPECbase*100, digits=2)` %) and `r richLake[1,2]` (`r richLake[1,1]`  in `r richLakeName`,   - `r round(richLake[1,2]/NSPECbase*100, digits=2)` %) virtual species can grow.



Compared with observed species richness: 
```{r}
real_Barmsee <-MAK_grouped_depthindep %>% filter(Lake=="Barmsee") %>%
  filter(Group!="none") %>% ungroup() %>% summarise(NSPECperc=sum(NSPECperc))
```
Observed species richness in Barmsee: `r real_Barmsee`



```{r}
real_Langbuerg<-MAK_grouped_depthindep %>% filter(Lake=="Langbuergner See") %>%
  filter(Group!="none") %>% ungroup() %>% summarise(NSPECperc=sum(NSPECperc))
```
Observed spec richness in lake Langb√ºrgner: `r real_Langbuerg`




### Per lake type

Potential species richness per lake type and species group (%):

```{r}
Nspecies_P_groupes<-data %>%
  left_join((data_lakes_env_class %>% 
               select(Lake, class)%>%
               mutate(Lake=paste0("lake_",Lake))),
            by=c("Lake"))%>%
  group_by(class, specNr, Group) %>%
  summarise_at(vars(Biomass_cat), ~ sum(. != 0)) %>%
  mutate(Biomass_cat=ifelse(Biomass_cat>0,1,0))%>%
  
  ungroup() %>% group_by(class, Group) %>%
  summarise(Biomass_cat=sum(Biomass_cat)) %>%
  rename("Nspecies" = Biomass_cat) %>%
  mutate(Nspecies_P = (Nspecies/NSPECbase)*100) %>%
  select(-Nspecies) %>%
  spread(Group, Nspecies_P)

Nspecies_P_groupes_all<-data %>%
  left_join((data_lakes_env_class %>% 
               select(Lake, class)%>%
               mutate(Lake=paste0("lake_",Lake))),
            by=c("Lake"))%>%
  
  group_by(class, specNr) %>%
  summarise_at(vars(Biomass_cat), ~ sum(. != 0)) %>%
  mutate(Biomass_cat=ifelse(Biomass_cat>0,1,0))%>%
  
  ungroup() %>% group_by(class) %>%
  summarise(Biomass_cat=sum(Biomass_cat)) %>%
  rename("Nspecies" = Biomass_cat) %>%
  mutate(Nspecies_P_all = (Nspecies/NSPECbase)*100) %>%
  select(-Nspecies) 

knitr::kable(left_join(Nspecies_P_groupes,Nspecies_P_groupes_all, by="class"), digits = 1) %>%
  kable_styling()


```




Observes species richness within lake types and per species groups (%)

```{r}
Nspaclakclass<-Makroph_comm_S %>%
  gather("Species", "Kohler",5:89) %>%
  mutate(Species = str_replace(Species, " ", "."))%>%
  left_join(GroupsSpecies, by = c("Species"="Taxon")) %>%
  select(-Trophie,-Typ, -Depth) %>%
  mutate(Gruppe = ifelse(is.na(Gruppe),"none", Gruppe)) %>%
  filter(!Lake %in% c("Altmuehlsee", "Drachensee", "Eixendorfer See",
                      "Grosser Brombachsee",
                     "Gruentensee","Igelsbachsee", "Kleiner Brombachsee",
                     "Liebensteinspeicher","Rottachsee",
                     "Steinberger See","Hofstaetter See",
                     "Untreusee","Walchensee","Murnersee","Rothsee",
                     "Seehamer See"))%>%
  rename(Group=Gruppe)%>%
  ungroup() %>%
  group_by(Lake) %>%
  filter(YEAR==max(YEAR))%>% #select last mapping per lake
  ungroup() %>%
  left_join(data_lakes_env_class, by=c("Lake"="LakeName")) %>%
  rename(LakeID=Lake.y) %>%
  
  
  group_by(Species, Group, class) %>%
  summarise_at(vars("Kohler"), sum, na.rm=T)%>% # Mean of Kohler per Lake, YEAR, Depth, Species and Group
  ungroup()%>%
  group_by(Group, class) %>%
  mutate(Kohler=ifelse(Kohler>0,1,0)) %>%
  summarise(NSPEC=sum(Kohler)) %>%
  mutate(NSPECperc = NSPEC/MAK_MAPPED_NSPEC_indicationspec$n*100) %>%
  select(-NSPEC)%>%
  spread(Group,NSPECperc)%>%
  rename(oligotrophic="1", mesotrophic="2", eutrophic="3")


Nspaclakclass_all<-Makroph_comm_S %>%
  gather("Species", "Kohler",5:89)%>%
  mutate(Species = str_replace(Species, " ", ".")) %>%
  left_join(GroupsSpecies, by = c("Species"="Taxon")) %>%
  select(-Trophie,-Typ, -Depth) %>%
  mutate(Gruppe = ifelse(is.na(Gruppe),"none", Gruppe)) %>%
  filter(!Lake %in% c("Altmuehlsee", "Drachensee", "Eixendorfer See",
                      "Grosser Brombachsee",
                     "Gruentensee","Igelsbachsee", "Kleiner Brombachsee",
                     "Liebensteinspeicher","Rottachsee",
                     "Steinberger See","Hofstaetter See",
                     "Untreusee","Walchensee","Murnersee","Rothsee",
                     "Seehamer See"))%>%
  rename(Group=Gruppe)%>%
  ungroup() %>%
  group_by(Lake) %>%
  filter(YEAR==max(YEAR))%>% #select last mapping per lake
  ungroup() %>%
  left_join(data_lakes_env_class, by=c("Lake"="LakeName")) %>%
  rename(LakeID=Lake.y) %>%
  filter(Group!="none")%>%
  
  group_by(Species, class) %>%
  summarise_at(vars("Kohler"), sum, na.rm=T)%>% # Mean of Kohler per Lake, YEAR, Depth, Species and Group
  ungroup()%>%
  group_by(class) %>%
  mutate(Kohler=ifelse(Kohler>0,1,0)) %>%
  summarise(NSPEC=sum(Kohler)) %>%
  mutate(NSPECperc_all = NSPEC/MAK_MAPPED_NSPEC_indicationspec$n*100) %>%
  select(-NSPEC)

knitr::kable(left_join(Nspaclakclass, Nspaclakclass_all, by="class"), digits = 1) %>% 
  kable_styling()

```





### FIG2 : Depth diversity gradient of potential and observed species richness  


```{r}
lakesDDGModel<-data %>% 
  group_by(Lake, Group) %>%
  summarise_at(vars(depth_1, depth_2, depth_3, depth_4), ~ sum(. != 0)) %>%
  gather("depth", "NSpec", c(3:6))%>%
  mutate(NSpecP=(NSpec/NSPECbase)*100) %>% 
  select(-NSpec) %>%
  mutate(type="model")  

lakesDDGMapped <- MAK_mapped_grouped %>%
  mutate(depth=ifelse(Depth==-5.0, "depth_4", 
                      ifelse(Depth==-3.0, "depth_3",
                             ifelse(Depth==-1.5, "depth_2",
                                    ifelse(Depth==-0.5, "depth_1",NA))))) %>%
  mutate(type="mapped") %>% 
  rename(NSpecP=NSPECperc) %>% 
  ungroup() %>%
  select(-NSPEC, -Depth, -Lake) %>% 
  relocate(depth, .after = Group) %>%
  relocate(LakeID, .before = Group) %>%
  rename(Lake=LakeID) %>%
  filter(Group!="none")%>%
  mutate(Group=ifelse(Group==1, "oligotroph", 
                      ifelse(Group==2, "mesotroph", 
                             ifelse(Group==3, "eutroph", NA))))

lakesDDG2 = rbind(lakesDDGModel,lakesDDGMapped)

lakesDDG = lakesDDG2 %>% 
  left_join(fulllakenames, by=c("Lake"="LakeID")) %>%
  rename(LakeName = Lake.y) %>% 
  mutate(depth=ifelse(depth=="depth_1","-0.5",
                      ifelse(depth=="depth_2","-1.5",
                             ifelse(depth=="depth_3","-3.0",
                                    ifelse(depth=="depth_4","-5.0","NA"))))) %>%
  mutate(Group=ifelse(Group=="eutroph","eutraphentic",
                      ifelse(Group=="mesotroph","mesotraphentic",
                             ifelse(Group=="oligotroph","oligotraphentic","NA"))))
```




```{r, fig.height=9, fig.width=6}
my.formula <- y ~ x 

lakeclasses<-c("clear lakes","intermediate lakes", "turbid lakes")
names(lakeclasses)<-c("clear","medium","turb")


A1<-lakesDDG %>%
  filter(type=="model")%>%
  left_join((data_lakes_env_class %>% mutate(Lake=paste0("lake_",Lake)) %>%
               select(-LakeName)),
            by=c("Lake"))%>%
  ggplot(aes(depth, NSpecP, col=Group, group=interaction(Group,Lake)))+
  #geom_path(alpha=0.5)+
  geom_boxplot(aes(group=interaction(depth,Group), fill=Group))+
  facet_grid(~class, 
              labeller = labeller(class = lakeclasses))+
  scale_colour_manual(values = c(rev(TrophiePalette)))+
  theme(legend.title = element_blank()) +
  xlab("Depth (m)")+ 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
  theme(legend.position = "none")+
  #ggtitle("Potential species richness (model)")+
  ylab("")+
  scale_fill_manual(values = c(rev(TrophiePalette)))+
  ylab("Potential \nspec. richness (%)")

A2<-lakesDDG %>%
  filter(type=="mapped")%>%
  left_join((data_lakes_env_class %>% mutate(Lake=paste0("lake_",Lake)) %>%
               select(-LakeName)),
            by=c("Lake"))%>%
  ggplot(aes(depth, NSpecP, col=Group, group=interaction(Group,Lake)))+
  #geom_path(alpha=0.5)+
  geom_boxplot(aes(group=interaction(depth,Group), fill=Group))+
  facet_grid(~class, 
              labeller = labeller(class = lakeclasses))+
  scale_colour_manual(values = c(rev(TrophiePalette)))+
  theme(legend.title = element_blank()) +
  xlab("")+ 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
  theme(legend.position = "none")+
  #ggtitle("Realised species richness (mapped)")+
  scale_fill_manual(values = c(rev(TrophiePalette)))+
  ylab("Observed \nspec. richness (%)")


A3<-lakesDDG %>%
  #filter(type=="mapped")%>%
  left_join((data_lakes_env_class %>% mutate(Lake=paste0("lake_",Lake)) %>%
               select(-LakeName)),
            by=c("Lake")) %>%
  spread(type,NSpecP) %>%
  ggplot(aes(x=model,y=mapped, col=Group))+
  geom_point()+
  facet_grid(~class, 
              labeller = labeller(class = lakeclasses))+ #aes(col=Name)
  #geom_smooth(model=lm, method=lm, se=F, formula = my.formula,
  #            #aes(group=factor(depth), col=factor(depth))
  #            )+
  stat_correlation(vstep = 0.1,label.x = "centre")+
  #stat_poly_eq(formula = my.formula,
  #              eq.with.lhs = "italic(hat(y))~`=`~",
  #              aes(label = paste(..rr.label.., sep = "~~~")))+
  scale_colour_manual(values = c(rev(TrophiePalette)))+
  #ggtitle("comparison")+ 
  geom_abline(intercept = 0, slope = 1)+
  #annotate("text", x = 22, y = 25, label = "model = mapped", angle=34)+
  xlab("Potential spec. richness (%)")+
  ylab("Observed \nspec. richness (%)")+
  ylim(0,40)+xlim(0,40)




```

```{r, fig.height=8, fig.width=6.5}
FIG2<-((A2/A1) / A3) +theme(legend.position = "bottom")+ 
  labs(col="Spec. group") + 
  plot_annotation(tag_levels = 'a',
                  tag_prefix = '(',
                  tag_suffix = ')')& 
  theme(plot.tag = element_text(size = 12))& 
  guides(colour = guide_legend(override.aes = list(size=3)))

FIG2

ggsave("Fig2.png", FIG2, width = 6.5, height=8, dpi="print", bg="white", scale=1.2)
ggsave("Fig2.svg", FIG2, width = 6.5, height=8, dpi="print", bg="white", scale=1.2)

```







### FIG5 - part: DDG

```{r, fig.height=3, fig.width=7}
Fig5_part<-lakesDDG %>%
  filter(type=="model")%>%
  left_join((data_lakes_env_class %>% mutate(Lake=paste0("lake_",Lake)) %>%
               select(-LakeName)),
            by=c("Lake"))%>%
  group_by(Group,depth,class) %>%
  summarise(NSpecPmean=mean(NSpecP),NSpecPsd=sd(NSpecP))%>%
  ggplot(aes(depth, NSpecPmean, col=Group, group=interaction(Group)))+
  #geom_boxplot(aes(group=interaction(depth,Group), fill=Group))+
  facet_grid(~class, 
              labeller = labeller(class = lakeclasses))+
  geom_path(position=position_dodge(0.5), size=1)+
  geom_errorbar(aes(ymin=NSpecPmean-NSpecPsd, ymax=NSpecPmean+NSpecPsd), width=.2,
                 position=position_dodge(0.5))+

  scale_colour_manual(values = c(rev(TrophiePalette)))+
  theme(legend.title = element_blank()) +
  xlab("Depth (m)")+ 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
  theme(legend.position = "bottom")+
  #ggtitle("Potential species richness (model)")+
  scale_fill_manual(values = c(rev(TrophiePalette)))+
  ylab("Mean potential \nspec. richness (%)")

Fig5_part

#ggsave("Fig5_part.png", Fig5_part, width = 6.5, height=3, dpi="print", bg="white")
```


## Q2 - Future Scenarios

### Bavaria

#### Number of lost species per scenario (%)
```{r}
#Berechnung √ºberpr√ºft

NSPECbase<-scenario_data %>% select(speciesID) %>% unique() %>% nrow()

SPEC_DEAD <- all_diff_presabs_tobase %>% 
  group_by(speciesID) %>% select(-lakeID,-variable) %>%
  summarise_all(sum) %>% #Pro Art Summe aus Tiefen und Seen
  #filter(base>0) %>% #nur Arten, die schon vorkamen
  select(base,S0_m1,S0_1,S0_2,S1_m1,S1_0, S1_1,S1_2,S2_m1,S2_0,S2_1,S2_2) %>%
  summarise_all(funs(sum(. > 0, na.rm = TRUE))) %>% # N species pro Szen if present
  gather("scenario","Ntotspec",1:12) %>% 
  mutate(Lost= Ntotspec - NSPECbase) %>% 
  mutate(Lost_percent = (Lost/NSPECbase)*100) %>% 
  filter(scenario!="base") %>% 
  mutate(Temp=c(0,0,0,1,1,1,1,2,2,2,2)) %>%
  mutate(TurbN=c(-1,1,2,-1,0,1,2,-1,0,1,2)) %>% 
  select(-Ntotspec,-Lost,-scenario) %>%
  spread(TurbN,Lost_percent) %>% 
  rename("lostsp(%)"="Temp")

knitr::kable(SPEC_DEAD, digits = 1)%>% kable_styling()

```




#### Nspec lost per functional type
```{r}
NSPECbaseGroup <- scenario_data %>% 
  filter(speciesID %in% c(14000:14300))%>% select(speciesID) %>% unique() %>% nrow()
SPEC_DEAD_group_oli <- all_diff_presabs_tobase %>% 
  filter(speciesID %in% c(14000:14300)) %>%
  group_by(speciesID) %>% select(-lakeID,-variable) %>%
  summarise_all(sum) %>% filter(base>0) %>% select(base,S0_m1,S0_1,S0_2,
                                                   S1_m1,S1_0, S1_1,S1_2,
                                                   S2_m1,S2_0,S2_1,S2_2) %>%
    summarise_all(funs(sum(. > 0, na.rm = TRUE))) %>%
  gather("scenario","Ntotspec",1:12) %>% 
  mutate(Lost= Ntotspec - NSPECbaseGroup) %>% 
  mutate(Lost_percent = (Lost/NSPECbaseGroup)*100) %>% 
  filter(scenario!="base") %>% 
  mutate(Temp=c(0,0,0,1,1,1,1,2,2,2,2)) %>%
  mutate(TurbN=c(-1,1,2,-1,0,1,2,-1,0,1,2)) %>% 
  select(-Ntotspec,-Lost,-scenario) %>%
  spread(TurbN,Lost_percent) %>% 
  rename("lostspOlig(%)"="Temp")

NSPECbaseGroup <- scenario_data %>% 
  filter(speciesID %in% c(15000:15300))%>% select(speciesID) %>% unique() %>% nrow()
SPEC_DEAD_group_meso <- all_diff_presabs_tobase %>% 
  filter(speciesID %in% c(15001:15300)) %>%
  group_by(speciesID) %>% select(-lakeID,-variable) %>%
  summarise_all(sum) %>% filter(base>0) %>% select(base,S0_m1,S0_1,S0_2,
                                                   S1_m1,S1_0, S1_1,S1_2,
                                                   S2_m1,S2_0,S2_1,S2_2) %>%
    summarise_all(funs(sum(. > 0, na.rm = TRUE))) %>%
  gather("scenario","Ntotspec",1:12) %>% 
  mutate(Lost= Ntotspec - NSPECbaseGroup) %>% 
  mutate(Lost_percent = (Lost/NSPECbaseGroup)*100) %>% 
  filter(scenario!="base") %>% 
  mutate(Temp=c(0,0,0,1,1,1,1,2,2,2,2)) %>%
  mutate(TurbN=c(-1,1,2,-1,0,1,2,-1,0,1,2)) %>% 
  select(-Ntotspec,-Lost,-scenario) %>%
  spread(TurbN,Lost_percent) %>% 
  rename("lostspMeso(%)"="Temp")

NSPECbaseGroup <- scenario_data %>% 
  filter(speciesID %in% c(16000:16300))%>% select(speciesID) %>% unique() %>% nrow()

SPEC_DEAD_group_eu <- all_diff_presabs_tobase %>% 
  filter(speciesID %in% c(16001:16300)) %>%
  group_by(speciesID) %>% select(-lakeID,-variable) %>%
  summarise_all(sum) %>% filter(base>0) %>% select(base,S0_m1,S0_1,S0_2,
                                                   S1_m1,S1_0, S1_1,S1_2,
                                                   S2_m1,S2_0,S2_1,S2_2) %>%
    summarise_all(funs(sum(. > 0, na.rm = TRUE))) %>%
  gather("scenario","Ntotspec",1:12) %>% 
  mutate(Lost= Ntotspec - NSPECbaseGroup) %>% 
  mutate(Lost_percent = (Lost/NSPECbaseGroup)*100) %>% 
  filter(scenario!="base") %>% 
  mutate(Temp=c(0,0,0,1,1,1,1,2,2,2,2)) %>%
  mutate(TurbN=c(-1,1,2,-1,0,1,2,-1,0,1,2)) %>% 
  select(-Ntotspec,-Lost,-scenario) %>%
  spread(TurbN,Lost_percent) %>% 
  rename("lostspeu(%)"="Temp")

knitr::kable(SPEC_DEAD_group_oli, digits = 1)%>% kable_styling()
knitr::kable(SPEC_DEAD_group_meso, digits = 1)%>% kable_styling()
knitr::kable(SPEC_DEAD_group_eu, digits = 1)%>% kable_styling()

```




<br/><br/>

#### Number of locally extinct species per lake type
Scenarios:
* S0_1: +25% Turbidity and Nutrients
* S0_2: +50% Turbidity and Nutrients
* S0_m1: -25% Turbidity and Nutrients
* S1_0: +1.5¬∞C; 
* S1_1: +1.5¬∞C; +25% Turbidity and Nutrients
* S1_2: +1.5¬∞C; +50% Turbidity and Nutrients
* S1_m1: +1.5¬∞C; -25% Turbidity and Nutrients
* S2_0: +3.0¬∞C; 
* S2_1: +3.0¬∞C; +25% Turbidity and Nutrients
* S2_2: +3.0¬∞C; +50% Turbidity and Nutrients
* S2_m1: +3.0¬∞C; -25% Turbidity and Nutrients




```{r}

all_diff_presabs_tobase %>%
  left_join((data_lakes_env_class %>% 
               select(Lake, class)),
            by=c("lakeID"="Lake"))%>% 
  group_by(speciesID, class) %>% select(-lakeID,-variable) %>%
  summarise_all(sum) %>% filter(base>0) %>% select(class,base,S0_m1,S0_1,S0_2,
                                                   S1_m1,S1_0, S1_1,S1_2,
                                                   S2_m1,S2_0,S2_1,S2_2) %>%
  mutate_at(vars(base,S0_m1,S0_1,S0_2,S1_m1,S1_0, S1_1,S1_2,
                 S2_m1,S2_0,S2_1,S2_2), ~ 1 * (. != 0)) %>%
  ungroup() %>% group_by(class) %>% select(-speciesID) %>%
  summarise_all(sum) %>%
    
  gather("scenario","Ntotspec",3:13) %>% 
  mutate(Lost= Ntotspec - base) %>% 
  mutate(Lost_percent = (Lost/base)*100) %>% select(-base,-Lost,-Ntotspec) %>%
  spread(class,Lost_percent) %>%
  kable() %>% kable_styling()
```




### Per lake and depth 

#### Mean Number of species per lake (+sd) and scenario
Colums: Turbidity and Nutrient change (-1=-25%;0=+0%;1=+25%;2=+50%)
Rows: Temperature change(0=+0¬∞C; 1=+1.5¬∞C; 2=+3.0¬∞C)
```{r, message=FALSE}

# Mean n of species per scenario ***
all_diff_prsabsMEAN <- all_diff_presabs_tobase %>%
  group_by(lakeID, speciesID) %>%
  summarise( #tiefenunabh√§ngig Vorkommen in den Seen
    NspecXDepthsB = sum(base),
    NspecXDepthsS0_m1 = sum(S0_m1),
    NspecXDepthsS0_1 = sum(S0_1),
    NspecXDepthsS0_2 = sum(S0_2),
    NspecXDepthsS1_m1 = sum(S1_m1),
    NspecXDepthsS1_0 = sum(S1_0),
    NspecXDepthsS1_1 = sum(S1_1),
    NspecXDepthsS1_2 = sum(S1_2),
    NspecXDepthsS2_m1 = sum(S2_m1),
    NspecXDepthsS2_0 = sum(S2_0),
    NspecXDepthsS2_1 = sum(S2_1),
    NspecXDepthsS2_2 = sum(S2_2)
  ) %>%
  mutate_at(vars(NspecXDepthsB, NspecXDepthsS0_m1,NspecXDepthsS0_1, 
                 NspecXDepthsS0_2, 
                 NspecXDepthsS1_m1, NspecXDepthsS1_0, 
                 NspecXDepthsS1_1, NspecXDepthsS1_2,
                 NspecXDepthsS2_m1,NspecXDepthsS2_0,
                 NspecXDepthsS2_1,NspecXDepthsS2_2), ~ 1 * (. != 0)) %>% # Pres/Abs
  ungroup() %>%
  group_by(lakeID) %>%
  summarise( #Arten pro See
    base = sum(NspecXDepthsB),
    S0_m1 = sum(NspecXDepthsS0_m1),
    S0_1 = sum(NspecXDepthsS0_1),
    S0_2 = sum(NspecXDepthsS0_2),
    S1_m1 = sum(NspecXDepthsS1_m1),
    S1_0 = sum(NspecXDepthsS1_0),
    S1_1 = sum(NspecXDepthsS1_1),
    S1_2 = sum(NspecXDepthsS1_2),
    S2_m1 = sum(NspecXDepthsS2_m1),
    S2_0 = sum(NspecXDepthsS2_0),
    S2_1 = sum(NspecXDepthsS2_1),
    S2_2 = sum(NspecXDepthsS2_2)
  ) %>%
  gather("scenario", "NSpec", 2:13) %>%
  group_by(scenario)  %>% 
  summarise(NSpMean = mean(NSpec))%>%
  arrange(factor(scenario, 
                 levels = c("S0_m1","base","S0_1","S0_2","S1_m1",
                            "S1_0","S1_1","S1_2",
                                      "S2_m1","S2_0","S2_1","S2_2")))

all_diff_prsabsSD <- all_diff_presabs_tobase %>%
  group_by(lakeID, speciesID) %>%
  summarise(
    NspecXDepthsB = sum(base),
    NspecXDepthsS0_m1 = sum(S0_m1),
    NspecXDepthsS0_1 = sum(S0_1),
    NspecXDepthsS0_2 = sum(S0_2),
    NspecXDepthsS1_m1 = sum(S1_m1),
    NspecXDepthsS1_0 = sum(S1_0),
    NspecXDepthsS1_1 = sum(S1_1),
    NspecXDepthsS1_2 = sum(S1_2),
    NspecXDepthsS2_m1 = sum(S2_m1),
    NspecXDepthsS2_0 = sum(S2_0),
    NspecXDepthsS2_1 = sum(S2_1),
    NspecXDepthsS2_2 = sum(S2_2)
  ) %>%
  mutate_at(vars(NspecXDepthsB, NspecXDepthsS0_m1,NspecXDepthsS0_1, 
                 NspecXDepthsS0_2, 
                 NspecXDepthsS1_m1, NspecXDepthsS1_0, 
                 NspecXDepthsS1_1, NspecXDepthsS1_2,
                 NspecXDepthsS2_m1,NspecXDepthsS2_0,NspecXDepthsS2_1,
                 NspecXDepthsS2_2), ~ 1 * (. != 0)) %>%
  ungroup() %>%
  group_by(lakeID) %>%
  summarise(
    base = sum(NspecXDepthsB),
    S0_m1 = sum(NspecXDepthsS0_m1),
    S0_1 = sum(NspecXDepthsS0_1),
    S0_2 = sum(NspecXDepthsS0_2),
    S1_m1 = sum(NspecXDepthsS1_m1),
    S1_0 = sum(NspecXDepthsS1_0),
    S1_1 = sum(NspecXDepthsS1_1),
    S1_2 = sum(NspecXDepthsS1_2),
    S2_m1 = sum(NspecXDepthsS2_m1),
    S2_0 = sum(NspecXDepthsS2_0),
    S2_1 = sum(NspecXDepthsS2_1),
    S2_2 = sum(NspecXDepthsS2_2)
  ) %>%
  gather("scenario", "NSpec", 2:13) %>%
  group_by(scenario)  %>% 
  summarise(NSpMean = sd(NSpec))%>%
  arrange(factor(scenario, 
                 levels = c("S0_m1","base","S0_1","S0_2","S1_m1",
                            "S1_0","S1_1","S1_2",
                            "S2_m1","S2_0","S2_1","S2_2")))

knitr::kable(all_diff_prsabsMEAN %>% mutate(Temp=c(0,0,0,0,1,1,1,1,2,2,2,2),
                               NutTurb=c(-1,0,1,2,-1,0,1,2,-1,0,1,2)) %>%
  select(-scenario) %>%
  spread(NutTurb,NSpMean) %>% rename("meanSpN"="Temp"), digits = 1)%>% kable_styling()

knitr::kable(all_diff_prsabsSD %>% mutate(Temp=c(0,0,0,0,1,1,1,1,2,2,2,2),
                               NutTurb=c(-1,0,1,2,-1,0,1,2,-1,0,1,2)) %>%
  select(-scenario) %>%
  spread(NutTurb,NSpMean) %>% rename("sdSpN"="Temp"), 
  digits = 1) %>% kable_styling()

# all_diff_presabs_tobase %>%
#   group_by(speciesID) %>% summarise(base=sum(base))

```




#### Mean Number of species per lake type and species group


```{r}
# Mean n of species per scenario ***
all_diff_prsabsMEAN_o <- all_diff_presabs_tobase %>%
  filter(speciesID %in% c(14000:14300)) %>% 
  group_by(lakeID, speciesID) %>%
  summarise(
    NspecXDepthsB = sum(base),
    NspecXDepthsS0_m1 = sum(S0_m1),
    NspecXDepthsS0_1 = sum(S0_1),
    NspecXDepthsS0_2 = sum(S0_2),
    NspecXDepthsS1_m1 = sum(S1_m1),
    NspecXDepthsS1_0 = sum(S1_0),
    NspecXDepthsS1_1 = sum(S1_1),
    NspecXDepthsS1_2 = sum(S1_2),
    NspecXDepthsS2_m1 = sum(S2_m1),
    NspecXDepthsS2_0 = sum(S2_0),
    NspecXDepthsS2_1 = sum(S2_1),
    NspecXDepthsS2_2 = sum(S2_2)
  ) %>%
  mutate_at(vars(NspecXDepthsB, NspecXDepthsS0_m1,NspecXDepthsS0_1, 
                 NspecXDepthsS0_2, 
                 NspecXDepthsS1_m1, NspecXDepthsS1_0, 
                 NspecXDepthsS1_1, NspecXDepthsS1_2,
                 NspecXDepthsS2_m1,NspecXDepthsS2_0,
                 NspecXDepthsS2_1,NspecXDepthsS2_2), ~ 1 * (. != 0)) %>%
  ungroup() %>%
  group_by(lakeID) %>%
  summarise(
    base = sum(NspecXDepthsB),
    S0_m1 = sum(NspecXDepthsS0_m1),
    S0_1 = sum(NspecXDepthsS0_1),
    S0_2 = sum(NspecXDepthsS0_2),
    S1_m1 = sum(NspecXDepthsS1_m1),
    S1_0 = sum(NspecXDepthsS1_0),
    S1_1 = sum(NspecXDepthsS1_1),
    S1_2 = sum(NspecXDepthsS1_2),
    S2_m1 = sum(NspecXDepthsS2_m1),
    S2_0 = sum(NspecXDepthsS2_0),
    S2_1 = sum(NspecXDepthsS2_1),
    S2_2 = sum(NspecXDepthsS2_2)
  ) %>%
  gather("scenario", "NSpec", 2:13) %>%
  group_by(scenario)  %>% 
  summarise(NSpMean = mean(NSpec))%>%
  arrange(factor(scenario, 
                 levels = c("S0_m1","base","S0_1","S0_2","S1_m1",
                            "S1_0","S1_1","S1_2",
                                      "S2_m1","S2_0","S2_1","S2_2")))

all_diff_prsabsMEAN_m <- all_diff_presabs_tobase %>%
  filter(speciesID %in% c(15001:15300)) %>% 
  group_by(lakeID, speciesID) %>%
  summarise(
    NspecXDepthsB = sum(base),
    NspecXDepthsS0_m1 = sum(S0_m1),
    NspecXDepthsS0_1 = sum(S0_1),
    NspecXDepthsS0_2 = sum(S0_2),
    NspecXDepthsS1_m1 = sum(S1_m1),
    NspecXDepthsS1_0 = sum(S1_0),
    NspecXDepthsS1_1 = sum(S1_1),
    NspecXDepthsS1_2 = sum(S1_2),
    NspecXDepthsS2_m1 = sum(S2_m1),
    NspecXDepthsS2_0 = sum(S2_0),
    NspecXDepthsS2_1 = sum(S2_1),
    NspecXDepthsS2_2 = sum(S2_2)
  ) %>%
  mutate_at(vars(NspecXDepthsB, NspecXDepthsS0_m1,NspecXDepthsS0_1, 
                 NspecXDepthsS0_2, 
                 NspecXDepthsS1_m1, NspecXDepthsS1_0, 
                 NspecXDepthsS1_1, NspecXDepthsS1_2,
                 NspecXDepthsS2_m1,NspecXDepthsS2_0,
                 NspecXDepthsS2_1,NspecXDepthsS2_2), ~ 1 * (. != 0)) %>%
  ungroup() %>%
  group_by(lakeID) %>%
  summarise(
    base = sum(NspecXDepthsB),
    S0_m1 = sum(NspecXDepthsS0_m1),
    S0_1 = sum(NspecXDepthsS0_1),
    S0_2 = sum(NspecXDepthsS0_2),
    S1_m1 = sum(NspecXDepthsS1_m1),
    S1_0 = sum(NspecXDepthsS1_0),
    S1_1 = sum(NspecXDepthsS1_1),
    S1_2 = sum(NspecXDepthsS1_2),
    S2_m1 = sum(NspecXDepthsS2_m1),
    S2_0 = sum(NspecXDepthsS2_0),
    S2_1 = sum(NspecXDepthsS2_1),
    S2_2 = sum(NspecXDepthsS2_2)
  ) %>%
  gather("scenario", "NSpec", 2:13) %>%
  group_by(scenario)  %>% 
  summarise(NSpMean = mean(NSpec))%>%
  arrange(factor(scenario, 
                 levels = c("S0_m1","base","S0_1","S0_2","S1_m1",
                            "S1_0","S1_1","S1_2",
                                      "S2_m1","S2_0","S2_1","S2_2")))

all_diff_prsabsMEAN_e <- all_diff_presabs_tobase %>%
  filter(speciesID %in% c(16001:16300)) %>% 
  group_by(lakeID, speciesID) %>%
  summarise(
    NspecXDepthsB = sum(base),
    NspecXDepthsS0_m1 = sum(S0_m1),
    NspecXDepthsS0_1 = sum(S0_1),
    NspecXDepthsS0_2 = sum(S0_2),
    NspecXDepthsS1_m1 = sum(S1_m1),
    NspecXDepthsS1_0 = sum(S1_0),
    NspecXDepthsS1_1 = sum(S1_1),
    NspecXDepthsS1_2 = sum(S1_2),
    NspecXDepthsS2_m1 = sum(S2_m1),
    NspecXDepthsS2_0 = sum(S2_0),
    NspecXDepthsS2_1 = sum(S2_1),
    NspecXDepthsS2_2 = sum(S2_2)
  ) %>%
  mutate_at(vars(NspecXDepthsB, NspecXDepthsS0_m1,NspecXDepthsS0_1, 
                 NspecXDepthsS0_2, 
                 NspecXDepthsS1_m1, NspecXDepthsS1_0, 
                 NspecXDepthsS1_1, NspecXDepthsS1_2,
                 NspecXDepthsS2_m1,NspecXDepthsS2_0,
                 NspecXDepthsS2_1,NspecXDepthsS2_2), ~ 1 * (. != 0)) %>%
  ungroup() %>%
  group_by(lakeID) %>%
  summarise(
    base = sum(NspecXDepthsB),
    S0_m1 = sum(NspecXDepthsS0_m1),
    S0_1 = sum(NspecXDepthsS0_1),
    S0_2 = sum(NspecXDepthsS0_2),
    S1_m1 = sum(NspecXDepthsS1_m1),
    S1_0 = sum(NspecXDepthsS1_0),
    S1_1 = sum(NspecXDepthsS1_1),
    S1_2 = sum(NspecXDepthsS1_2),
    S2_m1 = sum(NspecXDepthsS2_m1),
    S2_0 = sum(NspecXDepthsS2_0),
    S2_1 = sum(NspecXDepthsS2_1),
    S2_2 = sum(NspecXDepthsS2_2)
  ) %>%
  gather("scenario", "NSpec", 2:13) %>%
  group_by(scenario)  %>% 
  summarise(NSpMean = mean(NSpec))%>%
  arrange(factor(scenario, 
                 levels = c("S0_m1","base","S0_1","S0_2","S1_m1",
                            "S1_0","S1_1","S1_2",
                                      "S2_m1","S2_0","S2_1","S2_2")))

knitr::kable(all_diff_prsabsMEAN_o %>% 
               mutate(Temp=c(0,0,0,0,1,1,1,1,2,2,2,2),
                      NutTurb=c(-1,0,1,2,-1,0,1,2,-1,0,1,2)) %>%
               select(-scenario) %>%
               spread(NutTurb,NSpMean) %>% 
               rename("meanSpN_oligo"="Temp"), digits = 1)%>% kable_styling()

knitr::kable(all_diff_prsabsMEAN_m %>% 
               mutate(Temp=c(0,0,0,0,1,1,1,1,2,2,2,2),
                      NutTurb=c(-1,0,1,2,-1,0,1,2,-1,0,1,2)) %>%
               select(-scenario) %>%
               spread(NutTurb,NSpMean) %>% 
               rename("meanSpN_meso"="Temp"), digits = 1)%>% kable_styling()

knitr::kable(all_diff_prsabsMEAN_e %>% 
               mutate(Temp=c(0,0,0,0,1,1,1,1,2,2,2,2),
                      NutTurb=c(-1,0,1,2,-1,0,1,2,-1,0,1,2)) %>%
               select(-scenario) %>%
               spread(NutTurb,NSpMean) %>% 
               rename("meanSpN_eu"="Temp"), digits = 1)%>% kable_styling()
```





#### FIG3 : Scenarios
```{r}
#PANEL B TURB/NUTR
scentunutlabel<-c(TurbNutm1="-25%",TurbNut1="+25%")#
Fig3B<-all_diff_presabs_tobase %>% 
  left_join(data_lakes_env_class %>% select(Lake,class), by=c("lakeID"="Lake")) %>%
  mutate(Trophie = ifelse(speciesID %in% c(14001:14300), "oligotraphentic",
                          ifelse(speciesID %in% c(15001:15300), "mesotraphentic",
                                 ifelse(speciesID %in% c(16001:16300), "eutraphentic",NA))))%>%

  group_by(lakeID, variable,Trophie, class) %>% 
  summarise( #pro See und Tiefe Anzahl der Arten
    base = sum(base),
    S0m1 = sum(S0_m1),
    S01 = sum(S0_1),
    S02 = sum(S0_2),
    S1m1 = sum(S1_m1),
    S10 = sum(S1_0),
    S11 = sum(S1_1),
    S12 = sum(S1_2),
    S2m1 = sum(S2_m1),
    S20 = sum(S2_0),
    S21 = sum(S2_1),
    S22 = sum(S2_2)
   ) %>%
    mutate(
    S0m1minusBaseP = (S0m1 - base),
    S01minusBaseP = (S01 - base),
    S02minusBaseP = (S02 - base),
    S1m1minusBaseP = (S1m1- base),
    S10minusBaseP = (S10 - base),
    S11minusBaseP = (S11 - base),
    S12minusBaseP = (S12 - base),
    S2m1minusBaseP = (S2m1 - base),
    S20minusBaseP = (S20 - base),
    S21minusBaseP = (S21 - base),
    S22minusBaseP = (S22 - base)
  )%>% 
  ungroup() %>%
  group_by(variable,Trophie, class) %>% 
  select(-lakeID, -S0m1,-S01,-S02,-S1m1,-S10,-S11, -S12,-S2m1,-S20,-S21,-S22) %>%
  summarise_all(list(mean=mean, sd=sd)) %>%
  gather("scenario", "NSpec", c(5:15,17:27)) %>% 
  mutate(type=str_extract(scenario,"[^_]+$"),
         scenario=str_extract(scenario, "[^_]+")) %>%
  spread(type, NSpec) %>%
  
  mutate(scenarioTemp = ifelse(scenario=="base" | scenario=="S01minusBaseP" | 
                              scenario=="S02minusBaseP" | scenario=="S0m1minusBaseP", "Temp0", 
                    ifelse(scenario=="S10minusBaseP" | scenario=="S11minusBaseP" | 
                          scenario=="S12minusBaseP" | scenario=="S1m1minusBaseP", "Temp1",
                    ifelse(scenario=="S20minusBaseP" | scenario=="S21minusBaseP" |
                           scenario=="S22minusBaseP" | scenario=="S2m1minusBaseP",
                           "Temp2",NA)))) %>%
  mutate(scenarioTurbNut = ifelse(scenario=="base" | scenario=="S10minusBaseP" |
                                  scenario=="S20minusBaseP", "TurbNut0", 
                           ifelse(scenario=="S0m1minusBaseP" | scenario=="S1m1minusBaseP" |
                                        scenario=="S2m1minusBaseP", "TurbNutm1",
                           ifelse(scenario=="S01minusBaseP" | scenario=="S11minusBaseP" |
                                               scenario=="S21minusBaseP", "TurbNut1",
                           ifelse(scenario=="S02minusBaseP" | scenario=="S12minusBaseP" |
                                                      scenario=="S22minusBaseP", 
                                                    "TurbNut2", NA ))))) %>%
  filter(scenarioTemp=="Temp0")%>%
  filter(scenarioTurbNut!="TurbNut2")%>%
  filter(scenarioTurbNut=="TurbNut1")%>%
  ggplot(aes(factor(variable),mean, 
             group=interaction(Trophie, scenarioTemp)))+#, col=factor(Trophie
  geom_point(aes(col=interaction(Trophie)),
                position=position_dodge(width=0.5))+
  #geom_path(alpha=0.5, aes(col=interaction(Trophie)),
  #              position=position_dodge(width=0.5))+
  #geom_bar(stat="identity", aes(fill=factor(Trophie)), 
  #         position = position_dodge(width=0.5),
  #         width=0.5)+
  geom_errorbar(aes(ymax=mean+sd,
                    ymin=mean-sd,
                    col=interaction(Trophie)),
                position=position_dodge(width=0.5), width=.2)+
  #geom_boxplot()+
  facet_grid(scenarioTurbNut~class, 
              labeller = labeller(class = lakeclasses,
                                  scenarioTurbNut = scentunutlabel))+
  ylab("Potential spec. \nrichness change (N)")+
  theme(legend.position = "bottom")+
  scale_color_manual(values=rev(TrophiePalette))+
  theme(legend.title = element_blank())+
  scale_x_discrete(limits=rev)+ 
  geom_hline(yintercept=0, linetype="dashed", color = "black")+
  xlab("Depth (m)")+
  scale_y_continuous(limits=c(-60,60),breaks = seq(-60, 60, 20))+#,
    #sec.axis = dup_axis(name = expression(increase %<-% TurbNutr %->% decrease), 
     #                   breaks = NULL))+ 
  theme(axis.title.y.right = element_text(size=10,color = "grey50"))

```

```{r}
#PANEL A TEMPERATURE
scentemplabel<-c(Temp1="+1.5¬∞C",Temp2="+3¬∞C")#
Fig3A<-all_diff_presabs_tobase %>% 
  left_join(data_lakes_env_class %>% select(Lake,class), by=c("lakeID"="Lake")) %>%
  mutate(Trophie = ifelse(speciesID %in% c(14001:14300), "oligotraphentic",
                          ifelse(speciesID %in% c(15001:15300), "mesotraphentic",
                                 ifelse(speciesID %in% c(16001:16300), "eutraphentic",NA))))%>%

  group_by(lakeID, variable,Trophie, class) %>% 
  summarise( #pro See und Tiefe Anzahl der Arten
    base = sum(base),
    S0m1 = sum(S0_m1),
    S01 = sum(S0_1),
    S02 = sum(S0_2),
    S1m1 = sum(S1_m1),
    S10 = sum(S1_0),
    S11 = sum(S1_1),
    S12 = sum(S1_2),
    S2m1 = sum(S2_m1),
    S20 = sum(S2_0),
    S21 = sum(S2_1),
    S22 = sum(S2_2)
   ) %>%
    mutate(
    S0m1minusBaseP = (S0m1 - base),
    S01minusBaseP = (S01 - base),
    S02minusBaseP = (S02 - base),
    S1m1minusBaseP = (S1m1- base),
    S10minusBaseP = (S10 - base),
    S11minusBaseP = (S11 - base),
    S12minusBaseP = (S12 - base),
    S2m1minusBaseP = (S2m1 - base),
    S20minusBaseP = (S20 - base),
    S21minusBaseP = (S21 - base),
    S22minusBaseP = (S22 - base)
  )%>% 
  ungroup() %>%
  group_by(variable,Trophie, class) %>% 
  select(-lakeID, -S0m1,-S01,-S02,-S1m1,-S10,-S11, -S12,-S2m1,-S20,-S21,-S22) %>%
  summarise_all(list(mean=mean, sd=sd)) %>%
  
  
  gather("scenario", "NSpec", c(5:15,17:27)) %>% 
  mutate(type=str_extract(scenario,"[^_]+$"),
         scenario=str_extract(scenario, "[^_]+")) %>%
  spread(type, NSpec) %>%

  
  mutate(scenarioTemp = ifelse(scenario=="base" | scenario=="S01minusBaseP" | 
                              scenario=="S02minusBaseP" | scenario=="S0m1minusBaseP", "Temp0", 
                    ifelse(scenario=="S10minusBaseP" | scenario=="S11minusBaseP" | 
                          scenario=="S12minusBaseP" | scenario=="S1m1minusBaseP", "Temp1",
                    ifelse(scenario=="S20minusBaseP" | scenario=="S21minusBaseP" |
                           scenario=="S22minusBaseP" | scenario=="S2m1minusBaseP",
                           "Temp2",NA)))) %>%
  mutate(scenarioTurbNut = ifelse(scenario=="base" | scenario=="S10minusBaseP" |
                                  scenario=="S20minusBaseP", "TurbNut0", 
                           ifelse(scenario=="S0m1minusBaseP" | scenario=="S1m1minusBaseP" |
                                        scenario=="S2m1minusBaseP", "TurbNutm1",
                           ifelse(scenario=="S01minusBaseP" | scenario=="S11minusBaseP" |
                                               scenario=="S21minusBaseP", "TurbNut1",
                           ifelse(scenario=="S02minusBaseP" | scenario=="S12minusBaseP" |
                                                      scenario=="S22minusBaseP", 
                                                    "TurbNut2", NA ))))) %>%

  filter(scenarioTurbNut=="TurbNut0")%>%
  filter(scenarioTemp=="Temp2")%>%
  ggplot(aes(factor(variable),mean, 
             group=interaction(Trophie, scenarioTemp)))+#, col=factor(Trophie
  geom_point(aes(col=interaction(Trophie)),
                position=position_dodge(width=0.5))+
  #geom_path(alpha=0.5, aes(col=interaction(Trophie)),
  #              position=position_dodge(width=0.5))+
  #geom_bar(stat="identity", aes(fill=factor(Trophie)), 
  #         position = position_dodge(width=0.5),
  #         width=0.5)+
  geom_errorbar(aes(ymax=mean+sd,
                    ymin=mean-sd,
                    col=interaction(Trophie)),
                position=position_dodge(width=0.5), width=.2)+
  #geom_boxplot()+
  facet_grid(scenarioTemp~class, 
              labeller = labeller(class = lakeclasses, 
                                  scenarioTemp = scentemplabel))+
  ylab("Potential spec. \nrichness change (N)")+
  theme(legend.position = "bottom")+
  scale_color_manual(values=rev(TrophiePalette))+
  theme(legend.title = element_blank())+
  scale_x_discrete(limits=rev)+ 
  geom_hline(yintercept=0, linetype="dashed", color = "black")+
  xlab("Depth (m)") +
  #scale_y_continuous(limits=c(-30,30),breaks = seq(-30, 30, 10))+#,
    #sec.axis = dup_axis(name = expression(Temperature %->% increasing), 
     #                   breaks = NULL))+ 
  theme(axis.title.y.right = element_text(size=10,color = "grey50"),
        legend.position = "bottom")
#Fig3A
#scale_y_continuous(limits=c(-5,20),breaks = seq(0, 20, 10)
```









```{r}
# PANEL C VERSION 2
Fig3Cnew<-all_diff_presabs_tobase %>% 
  left_join(data_lakes_env_class %>% select(Lake,class), by=c("lakeID"="Lake")) %>%
  mutate(Trophie = ifelse(speciesID %in% c(14001:14300), "oligotraphentic",
                          ifelse(speciesID %in% c(15001:15300), "mesotraphentic",
                                 ifelse(speciesID %in% c(16001:16300), "eutraphentic",NA))))%>%

  group_by(lakeID, variable,Trophie, class) %>% 
  summarise( #pro See und Tiefe Anzahl der Arten
    base = sum(base),
    S0m1 = sum(S0_m1),
    S01 = sum(S0_1),
    S02 = sum(S0_2),
    S1m1 = sum(S1_m1),
    S10 = sum(S1_0),
    S11 = sum(S1_1),
    S12 = sum(S1_2),
    S2m1 = sum(S2_m1),
    S20 = sum(S2_0),
    S21 = sum(S2_1),
    S22 = sum(S2_2)
   ) %>%
    mutate(
    S0m1minusBaseP = (S0m1 - base),
    S01minusBaseP = (S01 - base),
    S02minusBaseP = (S02 - base),
    S1m1minusBaseP = (S1m1- base),
    S10minusBaseP = (S10 - base),
    S11minusBaseP = (S11 - base),
    S12minusBaseP = (S12 - base),
    S2m1minusBaseP = (S2m1 - base),
    S20minusBaseP = (S20 - base),
    S21minusBaseP = (S21 - base),
    S22minusBaseP = (S22 - base)
  )%>% 
  ungroup() %>%
  group_by(variable,Trophie, class) %>% 
  select(-lakeID, -S0m1,-S01,-S02,-S1m1,-S10,-S11, -S12,-S2m1,-S20,-S21,-S22) %>%
  summarise_all(list(mean=mean, sd=sd)) %>%
  
  
  gather("scenario", "NSpec", c(5:15,17:27)) %>% 
  mutate(type=str_extract(scenario,"[^_]+$"),
         scenario=str_extract(scenario, "[^_]+")) %>%
  spread(type, NSpec) %>%

  
  mutate(scenarioTemp = ifelse(scenario=="base" | scenario=="S01minusBaseP" | 
                              scenario=="S02minusBaseP" | scenario=="S0m1minusBaseP", "Temp0", 
                    ifelse(scenario=="S10minusBaseP" | scenario=="S11minusBaseP" | 
                          scenario=="S12minusBaseP" | scenario=="S1m1minusBaseP", "Temp1",
                    ifelse(scenario=="S20minusBaseP" | scenario=="S21minusBaseP" |
                           scenario=="S22minusBaseP" | scenario=="S2m1minusBaseP",
                           "Temp2",NA)))) %>%
  mutate(scenarioTurbNut = ifelse(scenario=="base" | scenario=="S10minusBaseP" |
                                  scenario=="S20minusBaseP", "TurbNut0", 
                           ifelse(scenario=="S0m1minusBaseP" | scenario=="S1m1minusBaseP" |
                                        scenario=="S2m1minusBaseP", "TurbNutm1",
                           ifelse(scenario=="S01minusBaseP" | scenario=="S11minusBaseP" |
                                               scenario=="S21minusBaseP", "TurbNut1",
                           ifelse(scenario=="S02minusBaseP" | scenario=="S12minusBaseP" |
                                                      scenario=="S22minusBaseP", 
                                                    "TurbNut2", NA ))))) %>%

  filter(scenarioTurbNut!="TurbNut0")%>%
  filter(scenarioTurbNut!="TurbNut2")%>%
  filter(scenarioTurbNut!="TurbNutm1")%>%
  filter(scenarioTemp=="Temp2")%>%
  mutate(scenarioTurbNut=ifelse(scenarioTurbNut=="TurbNut1","+3¬∞C\n+25%","NA")) %>%
  
  ggplot(aes(x=factor(variable),y=mean, 
             group=interaction(Trophie, scenarioTemp)))+#, col=factor(Trophie
  geom_point(aes(col=interaction(Trophie)),
                position=position_dodge(width=0.5))+
  #geom_path(alpha=0.5, aes(col=interaction(Trophie)),
  #              position=position_dodge(width=0.5))+
  #geom_bar(stat="identity", aes(fill=factor(Trophie)), 
  #         position = position_dodge(width=0.5),
  #         width=0.5)+
  geom_errorbar(aes(ymax=mean+sd,
                    ymin=mean-sd,
                    col=interaction(Trophie)),
                position=position_dodge(width=0.5), width=.2)+
  #geom_boxplot()+
  facet_grid(scenarioTurbNut~class, 
              labeller = labeller(class = lakeclasses))+
  ylab("Potential spec. \nrichness change (N)")+
  theme(legend.position = "bottom")+
  scale_color_manual(values=rev(TrophiePalette))+
  theme(legend.title = element_blank())+
  scale_x_discrete(limits=rev)+ 
  geom_hline(yintercept=0, linetype="dashed", color = "black")+
  xlab("Depth (m)") +
  scale_y_continuous(limits=c(-60,60),breaks = seq(-60, 60, 20))+#,
    #sec.axis = dup_axis(name = expression(Temperature %->% increasing), 
     #                   breaks = NULL))+ 
  theme(axis.title.y.right = element_text(size=10,color = "grey50"),
        legend.position = "bottom")
```




```{r, fig.height=12.0, fig.width=6.5}
#COMBINE PLOTS

FIG3fin<-((Fig3A + xlab(""))/ 
   (Fig3B + xlab("")) /
   (Fig3Cnew)) + 
  plot_annotation(tag_levels = 'a',
                  tag_prefix = '(',
                  tag_suffix = ')')+ 
  #labs(fill="Spec. group") + 
  plot_layout(heights = c(1, 1, 1)) + 
  plot_layout(guides = "collect")  &
  theme(legend.position = "bottom",
        strip.text.x = element_text(size = 8),
                strip.text.y = element_text(size = 10),
                axis.text.x = element_text(angle = 90, 
                                           vjust = 0.5, hjust=1),
                axis.title=element_text(size=10))& 
  theme(plot.margin =  unit(c(-0.0, 0.2, -0.0, 0.2), "cm"),
        plot.tag = element_text(size = 12))& 
  #guides(colour = guide_legend(override.aes = list(size=2)))&
  guides(colour=guide_legend(nrow=1,byrow=TRUE))

FIG3fin

ggsave("Fig3_f.png", FIG3fin, width = 7, height=10, dpi="print", bg="white", scale=0.75)
ggsave("Fig3_f.svg", FIG3fin, width = 7, height=10, dpi="print", bg="white", scale=0.75)

```



### Traits Winner / Loser (Q2.2, Fig4)


```{r}
WinnerLoserTraitsS0_1_S0_m1_all<-all_diff_presabs_tobase %>% 
  #filter(variable=="-3" | variable=="-5")%>%
  select(speciesID,lakeID, variable,base, S0_1,S0_m1) %>%
  group_by(speciesID, lakeID) %>% #to make it independent from depth
  summarise(S0_1=sum(S0_1),
            S0_m1=sum(S0_m1),
            base=sum(base)) %>%
  mutate(S0_1=ifelse(S0_1>0,1,0),
         S0_m1=ifelse(S0_m1>0,1,0),
         base=ifelse(base>0,1,0)) %>%
  mutate(S0_1minusBase=S0_1 - base,
         S0_m1minusBase=S0_m1 - base) %>%
  ungroup() %>%
  
  group_by(speciesID) %>%
  summarise(lakeWinLostS0_1 = sum(S0_1minusBase),
            lakeWinLostS0_m1 = sum(S0_m1minusBase)) %>%
  mutate(lakeWinLostS0_1=ifelse(lakeWinLostS0_1>0,1,
                            ifelse(lakeWinLostS0_1<0,-1,0)),
           lakeWinLostS0_m1=ifelse(lakeWinLostS0_m1>0,1,
                            ifelse(lakeWinLostS0_m1<0,-1,0))) %>%
  left_join(data_spec_para, by=c("speciesID"="specNr")) %>%
  select(-tuberEndAge, -Group)%>%
  gather("Scenario","WinLost",2:3) 


data.glmS0_1  <- WinnerLoserTraitsS0_1_S0_m1_all %>% 
  filter(Scenario=="lakeWinLostS0_1") %>%
  filter(WinLost!=0) %>%
  mutate(WinLost=factor(WinLost)) %>%
  select(-speciesID,-Scenario) %>%
  ungroup() %>%
  as.data.frame() %>%
  mutate_at(vars(-Species,-WinLost), normalize, method="range",range = c(0, 1))

modSpaceS0_1 <- glm(formula = factor(WinLost)~ . ,data=data.glmS0_1[,-c(1)], family = binomial())

summary(modSpaceS0_1)
glmSpace0_1 <- drop1(modSpaceS0_1, test="Chisq")

glmSpace0_1




# other szenario S0_m1
data.glmS0_m1  <- WinnerLoserTraitsS0_1_S0_m1_all %>% 
  filter(Scenario=="lakeWinLostS0_m1") %>%
  filter(WinLost!=0) %>%
  mutate(WinLost=factor(WinLost)) %>%
  select(-speciesID,-Scenario) %>%
  #spread(parameter,value)%>%
  ungroup() %>%
  as.data.frame() %>%
  mutate_at(vars(-Species,-WinLost), normalize, method="range",range = c(0, 1))

modSpaceS0_m1 <- glm(formula = factor(WinLost)~ . , 
                     data=data.glmS0_m1[,-c(1)], family = binomial())


summary(modSpaceS0_m1)
glmSpace0_m1 <- drop1(modSpaceS0_m1, test="Chisq")

glmSpace0_m1

#tab_model(modSpace)

## Select relevant (siginificant) parameters
toselect.S0_m1 <- summary(modSpaceS0_m1)$coeff[-1,4] < 0.05
relevant.S0_m1 <- names(toselect.S0_m1)[toselect.S0_m1 == TRUE] 

toselect.S0_1 <- summary(modSpaceS0_1)$coeff[-1,4] < 0.05
relevant.S0_1 <- names(toselect.S0_1)[toselect.S0_1 == TRUE] 

relevant <- c(relevant.S0_1,relevant.S0_m1) %>% unique()

T0_m1_all<-plot_model(modSpaceS0_m1, show.values = TRUE, 
           value.offset = .3, digits=1,sort.est = F,
           title = "",
           terms=relevant) #, 

T0_1_all<-plot_model(modSpaceS0_1, show.values = TRUE, 
           value.offset = .3, digits=1,sort.est = F,
           #title = "S0_1: Losers - Winners",
           terms = relevant) #,


Fig4fin<-(T0_m1_all+
    labs(subtitle = "(a) Decreased turbidity \nand nutrients (-25%)") + 
      labs(x="Species trait") + 
  theme(axis.text = element_text(face = "italic"))) + (T0_1_all+
  theme(axis.title.y=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank())+
    labs(subtitle = "(b) Increased turbidity \nand nutrients (25%)", title=""))

Fig4fin

Fig4fin_red<-(T0_1_all+
  theme(axis.title.y=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank())+
    labs(subtitle = "Increased turbidity \nand nutrients (25%)", title="")) #+

ggsave("Fig4.png", Fig4fin, width = 6.5, height=3.5, dpi="print", bg="white", scale =1.2)
```



How good are the GLMs
```{r}
# with(summary(modSpaceS0_1), 1 - deviance/null.deviance)
# with(summary(modSpaceS0_m1), 1 - deviance/null.deviance)
# 
# 
# library(ResourceSelection)
# hoslem.test(modSpaceS0_1$y, modSpaceS0_1$fitted)
# hoslem.test(modSpaceS0_m1$y, modSpaceS0_m1$fitted)

#https://easystats.github.io/performance/articles/r2.html 
performance::r2(modSpaceS0_1)
performance::r2(modSpaceS0_m1)

```
In the context of a generalized linear model (e.g., a logistic model which outcome is binary), R2 doesn‚Äôt measure the percentage of ‚Äúexplained variance‚Äù, as this concept doesn‚Äôt apply. However, the R2s that have been adapted for GLMs have retained the name of ‚ÄúR2‚Äù, mostly because of the similar properties (the range, the sensitivity, and the interpretation as the amount of explanatory power).

Number of Winners / Loser in both scenarios
```{r}
NWinnerLoserS0_1<-data.glmS0_1 %>% 
  count(WinLost) %>% 
  mutate(S0_1_P=(n/NSPECbase*100))%>% select(-n)
NWinnerLoserS0_m1<- data.glmS0_m1 %>% count(WinLost)%>%
  mutate(S0_m1_P=(n/NSPECbase*100))%>% select(-n)

NWinnerLoserS0_1 %>% left_join(NWinnerLoserS0_m1, by="WinLost")
```








